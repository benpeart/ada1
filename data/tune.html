<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ada Real-Time Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <canvas id="myChart" width="400" height="200"></canvas>

    <button name="plotStart" id="st" onclick=onStartStop(this); style="width:80px">Start</button>
    <button name="plotStop" id="sp" onclick=onStartStop(this); style="width:80px">Stop</button><br /><br />

    <fieldset style="width:300px">
        <legend>Plot control</legend>

        Sample rate [Hz]:<br />
        <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="8">25
        <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="4" checked>50
        <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="2">100
        <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="1">200<br /><br />

        Signals to plot<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this); checked>PID balance input<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this); checked>PID balance output<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Kalman filter angle<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Corrected gyro X<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Accelerometer X<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Accelerometer Y<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Accelerometer Z<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Gyro X<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Gyro Y<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Gyro Z<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Encoder count left<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Encoder count right<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Left motor speed<br />
        <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Right motor speed<br />
    </fieldset><br /><br />

    <fieldset style="width:300px">
        <legend>PID tuning</legend>
        <table>
            <tr>
                <td>Proportional gain:</td>
                <td><input type="range" id="pp" oninput=onTune(this); min="0" max="5" value="4" step="0.1"
                        class="slider"></td>
                <td><span id="pp_value">1</span></td>
            </tr>

            <tr>
                <td>Integral gain:</td>
                <td><input type="range" id="pi" oninput=onTune(this); min="0" max="1" value="0.25" step="0.01"
                        class="slider"></td>
                <td><span id="pa_value">0.05</span></td>
            </tr>

            <tr>
                <td>Derivative gain:</td>
                <td><input type="range" id="pd" oninput=onTune(this); min="0" max="2" value="1" step="0.01"
                        class="slider"></td>
                <td><span id="pd_value">0.25</span></td>
            </tr>
        </table>
    </fieldset>
</body>

<script>

    //
    // Chart helper functions
    //

    // remove the oldest data from each dataset
    function removeData(chart, update = true) {
        chart.data.labels.splice(0, 1);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.splice(0, 1);
        });
        if (update)
            chart.update();
    }

    // show or hide the given dataset
    function setVisibility(chart, index, hidden = false) {
        chart.getDatasetMeta(index).hidden = hidden;
    }

    // hide any signals are not to be plotted
    var PlotOption = function (e) {
        var plotOptions = document.getElementsByName("plotOption");
        var plotOptionLength = plotOptions.length;

        for (var i = 0; i < plotOptionLength; i++) {
            myChart.getDatasetMeta(i).hidden = !plotOptions[i].checked;
        }
    }

    const canvas = document.getElementById('myChart');
    const ctx = canvas.getContext('2d');

    const data = {
        labels: [],
        datasets: [{
            label: 'Balance PID input',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(128, 0, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Balance PID output',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(0, 128, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Kalman filter angle',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(0, 0, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Corrected gyro X',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(255, 0, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Accelerometer X',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(0, 255, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Accelerometer Y',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(0, 0, 255, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Accelerometer Z',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(255, 255, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Gyro X',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(0, 255, 255, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Gyro Y',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(255, 0, 255, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Gyro Z',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(192, 192, 192, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Encoder count left',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(192, 192, 192, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Encoder count right',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(128, 128, 128, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Left motor speed',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(128, 128, 0, 1)',
            fill: false,
            hidden: false,
        }, {
            label: 'Right motor speed',
            data: [],
            tension: 0.4,
            borderColor: 'rgba(0, 0, 128, 1)',
            fill: false,
            hidden: false,
        },
        ],
    }

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            animation: false, // Disable animation for real-time updates
            scales: {
                x: {
                    ticks: {
                        display: false
                    }
                }
            }
        },
    };

    // create the chart
    const myChart = new Chart(ctx, config);

    // initialize the signals to we want to plot based on what is checked
    PlotOption(this);

    //
    // Commands to be sent back to the host
    //

    // send start/stop command to the host
    var onStartStop = function (e) {
        connection.send(e.id);
    }

    // send sample rate to the host
    var onSampleRate = function (e) {
        connection.send(e.id + e.value);
    }

    // send update to the host and update slider-value in textfield
    var onTune = function (e) {
        // update the associated text
        document.getElementById(e.id + '_value').innerHTML = e.value;

        // send the tuning value to the the host
        connection.send(e.id + e.value);
    }

    // pass an array of data to be added to each item in the dataset
    function addData(chart, data) {
        // only show the latest 60 data points in chart
        if (chart.data.labels.length >= 128) {
            removeData(chart, false)
        };
        chart.data.labels.push(chart.data.labels.length);
        chart.data.datasets.forEach((dataset, index) => {
            dataset.data.push(data[index]);
        });
        chart.update();
    }

    // open a connection to the host
    var connection = new WebSocket('ws://' + location.hostname + ':81/', ['arduino']);
    connection.binaryType = 'arraybuffer';

    connection.onopen = function () {
    };

    connection.onerror = function (error) {
        console.log('WebSocket Error ', error);
    };

    connection.onmessage = function (e) {

        // Text message format is id of element (ie '2') followed by the float value to be stored in pg_value
        if (typeof (e.data) == 'string') {
            id = e.data.substr(0, 2);
            val = e.data.substr(2);
            e = document.getElementById(id);
            e.value = parseFloat(val);
            document.getElementById(id + '_value').innerHTML = e.value;
        } else {
            // Binary format is array of floats in binary/DataView format
            var d = e.data;
            var dv = new DataView(d);
            let newData = [];

            for (var i = 0; i < 14; i++) {
                newData[i] = dv.getFloat32(i * 4, true);
            }
            addData(myChart, newData);
        }
    };

</script>

</html>