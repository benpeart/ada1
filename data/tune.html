<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ada Real-Time Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: white;
            color: black;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: black;
                color: white;
            }
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
        }

        li {
            float: left;
        }

        li a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        li a:hover {
            background-color: #111;
        }
    </style>
</head>

<body>
    <canvas id="lineChart" width="400" height="200"></canvas>

    <button name="plotStart" id="st" onclick=onStartStop(this); style="width:80px">Start</button>
    <button name="plotStop" id="sp" onclick=onStartStop(this); style="width:80px">Stop</button><br /><br />

    <table>
        <tr>
            <td>
                <fieldset style="width:300px">
                    <legend>Plot control</legend>

                    Sample rate [Hz]:<br />
                    <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="8" checked>25
                    <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="4">50
                    <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="2">100
                    <input type="radio" id="sr" name="sampleRate" onclick=onSampleRate(this); value="1">200<br /><br />

                    Signals to plot<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this); checked>PID balance input<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this); checked>PID balance output<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Kalman filter angle<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Corrected gyro X<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Accelerometer X<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Accelerometer Y<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Accelerometer Z<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Gyro X<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Gyro Y<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Gyro Z<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Encoder count left<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Encoder count right<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this); checked>Left motor speed<br />
                    <input type="checkbox" name="plotOption" onchange=PlotOption(this);>Right motor speed<br />
                </fieldset>
            </td>

            <td style="vertical-align: top;">
                <fieldset style="width:300px">
                    <legend>PID tuning</legend>
                    <table>
                        <tr>
                            <td>Proportional gain:</td>
                            <td><input type="range" id="kp" oninput=onTune(this); min="0" max="32" value="21" step="0.5"
                                    class="slider"></td>
                            <td><span id="kp_value">1</span></td>
                        </tr>

                        <tr>
                            <td>Integral gain:</td>
                            <td><input type="range" id="ki" oninput=onTune(this); min="0" max="256" value="140" step="2"
                                    class="slider"></td>
                            <td><span id="ki_value">0.05</span></td>
                        </tr>

                        <tr>
                            <td>Derivative gain:</td>
                            <td><input type="range" id="kd" oninput=onTune(this); min="0" max="4" value="0.8" step="0.1"
                                    class="slider"></td>
                            <td><span id="kd_value">0.25</span></td>
                        </tr>
                    </table>
                </fieldset>
            </td>

            <td style="vertical-align: top;">
                <fieldset style="width:300px;">
                    <legend>Mode</legend>

                    <input type="radio" id="mp" name="mode" onclick=onMode(this); checked>Parked</br>
                    <input type="radio" id="ms" name="mode" onclick=onMode(this);>Standing Up</br>
                    <input type="radio" id="mk" name="mode" onclick=onMode(this);>Parking</br>
                    <input type="radio" id="md" name="mode" onclick=onMode(this);>Driving</br>
                    <input type="radio" id="mf" name="mode" onclick=onMode(this);>Fallen</br>
                    <input type="radio" id="mc" name="mode" onclick=onMode(this);>Calibrate</br>
                </fieldset><br /><br />
            </td>

        </tr>
    </table>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="tune.html">Tune</a></li>
        <li><a href="update">Upgrade</a></li>
        <li><a href="edit">Edit</a></li>
        <li><a href="credits.html">Credits</a></li>
    </ul>
    <script>

        //
        // Chart helper functions
        //

        // remove the oldest data from each dataset
        function removeData(chart, update = true) {
            chart.data.labels.splice(0, 1);
            chart.data.datasets.forEach((dataset) => {
                dataset.data.splice(0, 1);
            });
            if (update)
                chart.update();
        }

        // show or hide the given dataset
        function setVisibility(chart, index, hidden = false) {
            chart.getDatasetMeta(index).hidden = hidden;
        }

        // hide any signals are not to be plotted
        var PlotOption = function (e) {
            var plotOptions = document.getElementsByName("plotOption");
            var plotOptionLength = plotOptions.length;

            for (var i = 0; i < plotOptionLength; i++) {
                lineChart.getDatasetMeta(i).hidden = !plotOptions[i].checked;
            }
        }

        const canvas = document.getElementById('lineChart');
        const ctx = canvas.getContext('2d');

        const data = {
            labels: [],
            datasets: [{
                label: 'Balance PID input',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(128, 0, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Balance PID output',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(0, 128, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Kalman filter angle',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(0, 0, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Corrected gyro X',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(255, 0, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Accelerometer X',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(0, 255, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Accelerometer Y',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(0, 0, 255, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Accelerometer Z',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(255, 255, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Gyro X',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(0, 255, 255, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Gyro Y',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(255, 0, 255, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Gyro Z',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(192, 192, 192, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Encoder count left',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(192, 192, 192, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Encoder count right',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(128, 128, 128, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Left motor speed',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(128, 128, 0, 1)',
                fill: false,
                hidden: false,
            }, {
                label: 'Right motor speed',
                data: [],
                tension: 0.4,
                borderColor: 'rgba(0, 0, 128, 1)',
                fill: false,
                hidden: false,
            },
            ],
        }

        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                animation: false, // Disable animation for real-time updates
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            display: false
                        }
                    }
                }
            }
        }

        // create the chart
        const lineChart = new Chart(ctx, config);

        // initialize the signals to we want to plot based on what is checked
        PlotOption(this);

        //
        // Commands to be sent back to the host
        //

        // send mode command to the host
        var onMode = function (e) {
            connection.send(e.id);
        }

        // send start/stop command to the host
        var onStartStop = function (e) {
            connection.send(e.id);
        }

        // send sample rate to the host
        var onSampleRate = function (e) {
            connection.send(e.id + e.value);
        }

        // send update to the host and update slider-value in textfield
        var onTune = function (e) {
            // update the associated text
            document.getElementById(e.id + '_value').innerHTML = e.value;

            // send the tuning value to the the host
            connection.send(e.id + e.value);
        }

        // pass an array of data to be added to each item in the dataset
        function addData(chart, data) {
            // only show the latest 256 data points in chart
            if (chart.data.labels.length >= 256) {
                removeData(chart, false)
            };
            chart.data.labels.push(chart.data.labels.length);
            chart.data.datasets.forEach((dataset, index) => {
                dataset.data.push(data[index]);
            });
            chart.update();
        }

        // open a connection to the host
        var connection = new WebSocket('ws://' + location.hostname + ':81/', ['arduino']);
        connection.binaryType = 'arraybuffer';

        connection.onopen = function () {
        };

        connection.onerror = function (error) {
            console.log('WebSocket Error ', error);
        };

        connection.onmessage = function (e) {

            if (typeof (e.data) == 'string') {
                id = e.data.substr(0, 2);

                switch (id) {
                    // update the robot mode
                    case 'mp':
                    case 'ms':
                    case 'mk':
                    case 'md':
                    case 'mf':
                        document.getElementById(id).checked = true;
                        console.log('OnMessage ' + id + ' = checked');
                        break;

                    // Update pidAngle. Message format is id of element followed by the float value to be stored in pg_value
                    case 'kp':
                    case 'ki':
                    case 'kd':
                        val = parseFloat(e.data.substr(2));
                        document.getElementById(id).value = val;
                        document.getElementById(id + '_value').innerHTML = val;
                        console.log('OnMessage ' + id + ' = ' + val);
                        break;
                }

            } else {
                // Binary format is array of floats in binary/DataView format
                var d = e.data;
                var dv = new DataView(d);
                let newData = [];

                for (var i = 0; i < 14; i++) {
                    newData[i] = dv.getFloat32(i * 4, true);
                }
                addData(lineChart, newData);
            }
        };
    </script>
</body>

</html>